{% extends "base.html" %}
{% block content %}
  <h1>Collection: <code>{{ collection }}</code></h1>

  <section class="card">
    <h2>Add / Upsert chunk</h2>

    <div class="row">
      <input id="chunkId" type="text" placeholder="chunk.character.sahla.summary"/>
      <select id="chunkKind">
        <option value="thing_summary">thing_summary</option>
        <option value="thing_notes">thing_notes</option>
        <option value="connection_note">connection_note</option>
        <option value="chapter_text">chapter_text</option>
        <option value="scene_text">scene_text</option>
        <option value="rule_text">rule_text</option>
        <option value="misc">misc</option>
      </select>
    </div>

    <div class="row">
      <input id="thingId" type="text" placeholder="thing_id (e.g. character.sahla)"/>
      <input id="thingType" type="text" placeholder="thing_type (e.g. character, place, chapter)"/>
    </div>

    <div class="row">
      <input id="edgeId" type="text" placeholder="edge_id (if this chunk is about a connection)"/>
    </div>

    <textarea id="chunkText" rows="6" placeholder="Embedding text (summary, chapter chunk, rule statement, etc.)"></textarea>

    <div class="row">
      <input id="tags" type="text" placeholder="tags (comma-separated)"/>
      <input id="entityIds" type="text" placeholder="entity_ids (comma-separated)"/>
    </div>

    <div class="row">
      <input id="sourceFile" type="text" placeholder="source_file (optional)"/>
      <input id="sourceSection" type="text" placeholder="source_section (optional)"/>
    </div>

    <details class="mt">
      <summary>Chapter-style filters (optional)</summary>
      <div class="row mt">
        <input id="chapterNumber" type="number" placeholder="chapter_number"/>
        <input id="sceneId" type="text" placeholder="scene_id"/>
        <input id="pov" type="text" placeholder="pov"/>
        <input id="locationId" type="text" placeholder="location_id"/>
      </div>
    </details>

    <details class="mt">
      <summary>Extra metadata (optional JSON object)</summary>
      <textarea id="extraJson" rows="4" placeholder='{"draft_state":"revise","scene_id":"scene.12"}'></textarea>
    </details>

    <div class="row">
      <button onclick="upsertChunk('{{ collection }}')">Upsert chunk</button>
      <div id="upsertMsg" class="muted"></div>
    </div>

    <div class="muted">
      Tip: keep metadata flat so filtering stays reliable.
    </div>
  </section>

  <section class="card">
    <h2>Search</h2>
    <div class="row">
      <input id="queryText" type="text" placeholder="e.g. Sahla's birthplace"/>
      <input id="topK" type="number" min="1" max="50" value="8"/>

      <select id="queryChunkKind" multiple size="6" title="chunk_kinds (optional)">
        <option value="thing_summary">thing_summary</option>
        <option value="thing_notes">thing_notes</option>
        <option value="connection_note">connection_note</option>
        <option value="chapter_text">chapter_text</option>
        <option value="scene_text">scene_text</option>
        <option value="rule_text">rule_text</option>
        <option value="misc">misc</option>
      </select>

      <div class="column" style="gap:8px;">
        <input id="queryThingId" type="text" placeholder="Filter by thing_id (optional)"/>
        <input id="queryTags" type="text" placeholder="Filter by tags (comma-separated)"/>
      </div>

      <div class="column" style="gap:8px;">
        <label>thing_types</label>
        <select id="queryThingType" multiple size="6" title="thing_types (optional)">
          <option value="character">character</option>
          <option value="place">place</option>
          <option value="faction">faction</option>
          <option value="culture">culture</option>
          <option value="race">race</option>
          <option value="deity">deity</option>
          <option value="artifact">artifact</option>
          <option value="creature">creature</option>
          <option value="magic_concept">magic_concept</option>
          <option value="ritual">ritual</option>
          <option value="currency">currency</option>
          <option value="term">term</option>
          <option value="event">event</option>
          <option value="chapter">chapter</option>
          <option value="scene">scene</option>
          <option value="lore_entry">lore_entry</option>
          <option value="style_rule">style_rule</option>
          <option value="other">other</option>
        </select>
      </div>

      <button onclick="queryChunks('{{ collection }}')">Search</button>
    </div>
    <div id="results"></div>
  </section>

  <section class="card">
    <h2>Browse</h2>
    <div class="row">
      <input id="browseLimit" type="number" min="1" max="200" value="25"/>
      <button onclick="loadChunks('{{ collection }}')">Refresh</button>
      <div id="browseMsg" class="muted"></div>
    </div>
    <div id="docs"></div>
  </section>
{% endblock %}
