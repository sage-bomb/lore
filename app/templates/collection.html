{% extends "base.html" %}
{% block content %}
  <section class="hero">
    <div>
      <div class="eyebrow">Collection</div>
      <h1>{{ collection }}</h1>
      <p>Card-first editing, streamlined search, and connection management in one dark workspace.</p>
      <div class="pill-row" style="margin-top:8px;">
        <span class="pill">Add &amp; edit lore cards</span>
        <span class="pill">Search by meaning</span>
        <span class="pill">Manage connections</span>
      </div>
    </div>
    <div class="hero-card">
      <div class="small-label">Quick actions</div>
      <div class="row" style="margin-top:10px;">
        <button class="ghost" onclick="loadChunks('{{ collection }}')">Refresh cards</button>
        <button class="ghost" onclick="queryChunks('{{ collection }}')">Search now</button>
      </div>
      <div class="muted" style="margin-top:8px;">Use cards below to add lore, edit metadata, or delete connections fast.</div>
    </div>
  </section>

  <div class="tabs">
    <button class="tab active" data-tab="lore" onclick="switchTab('lore')">Lore cards</button>
    <button class="tab" data-tab="doc" onclick="switchTab('doc')">Document scout</button>
    <button class="tab" data-tab="chunking" onclick="switchTab('chunking')">Chunk review</button>
    <button class="tab" data-tab="connections" onclick="switchTab('connections')">Connections</button>
  </div>

  <div class="tab-panel" data-panel="lore" style="display:block;">
    <section class="card">
      <div class="card-header">
        <div>
          <h2 style="margin:0;">Search or browse</h2>
          <p class="card-subtitle">Both actions feed the same card list below for easy review.</p>
        </div>
        <div class="toolbar">
          <button class="ghost" onclick="queryChunks('{{ collection }}')">Search</button>
          <button class="secondary" onclick="loadChunks('{{ collection }}')">Browse</button>
          <button onclick="openCardModal()">Add card</button>
          <input id="browseLimit" type="number" min="1" max="200" value="25" style="width:110px;"/>
        </div>
      </div>
      <div class="grid three-col">
        <div class="stack">
          <label>Query text</label>
          <input id="queryText" type="text" placeholder="e.g. Sahla's birthplace"/>
        </div>
        <div class="stack">
          <label>Top results</label>
          <input id="topK" type="number" min="1" max="50" value="8"/>
        </div>
        <div class="stack">
          <label>Chunk kinds</label>
          <select id="queryChunkKind" multiple size="6" title="chunk_kinds (optional)">
            <option value="thing_summary">thing_summary</option>
            <option value="thing_notes">thing_notes</option>
            <option value="connection_note">connection_note</option>
            <option value="chapter_text">chapter_text</option>
            <option value="scene_text">scene_text</option>
            <option value="rule_text">rule_text</option>
            <option value="misc">misc</option>
          </select>
        </div>
        <div class="stack">
          <label>Thing types</label>
          <select id="queryThingType" multiple size="6" title="thing_types (optional)">
            <option value="character">character</option>
            <option value="place">place</option>
            <option value="faction">faction</option>
            <option value="culture">culture</option>
            <option value="race">race</option>
            <option value="deity">deity</option>
            <option value="artifact">artifact</option>
            <option value="creature">creature</option>
            <option value="magic_concept">magic_concept</option>
            <option value="ritual">ritual</option>
            <option value="currency">currency</option>
            <option value="term">term</option>
            <option value="event">event</option>
            <option value="chapter">chapter</option>
            <option value="scene">scene</option>
            <option value="lore_entry">lore_entry</option>
            <option value="style_rule">style_rule</option>
            <option value="other">other</option>
          </select>
        </div>
        <div class="stack">
          <label>thing_id filter</label>
          <input id="queryThingId" type="text" placeholder="Optional exact thing_id"/>
        </div>
        <div class="stack">
          <label>Tag filter</label>
          <input id="queryTags" type="text" placeholder="tags (comma-separated)"/>
        </div>
      </div>
      <div class="divider"></div>
      <div id="cardsStatus" class="muted">Use Search or Browse to populate cards.</div>
      <div id="cardsList" class="card-list" style="margin-top:10px;"></div>
    </section>
  </div>

  <div class="tab-panel" data-panel="doc" style="display:none;">
    <section class="card">
      <div class="card-header">
        <div>
          <h2 style="margin:0;">Document scout (OpenAI)</h2>
          <p class="card-subtitle">Upload a draft and review suggested lore snippets before accepting them.</p>
        </div>
        <button class="ghost" id="analyzeDocBtn">Analyze draft</button>
      </div>

      <div class="grid two-col">
        <div class="stack">
          <label>Upload documents</label>
          <input id="docFile" type="file" accept=".txt,.md,.doc,.docx,.pdf" multiple/>
          <div class="input-note">Select one or many files; they are stored so you can view them later.</div>
        </div>
        <div class="stack">
          <label>Notes for the model</label>
          <textarea id="docNotes" rows="3" placeholder="What should the model look for? e.g., characters, locations, rules"></textarea>
        </div>
      </div>

      <div class="stack" style="margin-top:12px;">
        <label>Paste document text (optional)</label>
        <textarea id="docText" rows="5" placeholder="If no file is uploaded, paste text here."></textarea>
      </div>

      <div class="stack" style="margin-top:12px;">
        <label>Optional URL</label>
        <input id="docUrl" type="text" placeholder="Paste a link to a chapter or doc (UI only)"/>
      </div>

      <div class="divider"></div>
      <div class="row" style="align-items:center; gap:10px;">
        <div id="docStatus" class="muted">Press analyze to send this document to OpenAI.</div>
        <div id="docSpinner" class="spinner" style="display:none;"><span class="spinner-text">Contacting OpenAI…</span></div>
      </div>
      <pre id="docLog" class="log" aria-live="polite"></pre>
      <div id="docResults" class="card-list" style="margin-top:12px;"></div>
    </section>
  </div>

  <div class="tab-panel" data-panel="chunking" style="display:none;">
    <section class="card" id="chunkReviewPanel">
      <div class="card-header">
        <div>
          <h2 style="margin:0;">Chunk review &amp; boundaries</h2>
          <p class="card-subtitle">Detect candidate chunks, adjust boundaries, and embed finalized slices.</p>
        </div>
        <div class="row">
          <button class="ghost" id="chunkSaveDraftBtn">Save draft</button>
          <button id="chunkSaveEmbedBtn">Save + Embed</button>
        </div>
      </div>

      <div class="grid two-col" style="margin-bottom:12px;">
        <div class="stack">
          <label>Document ID</label>
          <div class="row" style="align-items:flex-end;">
            <input id="chunkDocId" type="text" placeholder="doc.example.chapter1"/>
            <button class="ghost" id="chunkLoadBtn">Load by ID</button>
          </div>
          <div class="input-note">IDs persist drafts; provide one when detecting chunks.</div>
        </div>
        <div class="stack">
          <label>Chunk metadata defaults (for embedding)</label>
          <div class="grid three-col" style="gap:8px;">
            <div class="stack">
              <span class="mini-label">Chunk kind</span>
              <select id="chunkDefaultKind">
                <option value="chapter_text">chapter_text</option>
                <option value="scene_text">scene_text</option>
                <option value="thing_summary">thing_summary</option>
                <option value="thing_notes">thing_notes</option>
                <option value="misc">misc</option>
              </select>
            </div>
            <div class="stack">
              <span class="mini-label">Thing ID (optional)</span>
              <input id="chunkDefaultThingId" type="text" placeholder="character.sahla"/>
            </div>
            <div class="stack">
              <span class="mini-label">Thing type (optional)</span>
              <input id="chunkDefaultThingType" type="text" placeholder="character"/>
            </div>
            <div class="stack">
              <span class="mini-label">Tags (comma separated)</span>
              <input id="chunkDefaultTags" type="text" placeholder="chapter, draft"/>
            </div>
          </div>
        </div>
      </div>

      <div class="stack">
        <label>Document text</label>
        <textarea id="chunkDocText" rows="6" placeholder="Paste or load document text..."></textarea>
        <div class="row" style="justify-content:space-between;">
          <div class="row">
            <button class="ghost" id="chunkDetectBtn">Detect chunks</button>
            <div class="pill">Calls /api/chunking/detect</div>
          </div>
          <div class="row">
            <div class="stack mini">
              <span class="mini-label">Min chars</span>
              <input id="chunkMinChars" type="number" value="400" style="width:120px;"/>
            </div>
            <div class="stack mini">
              <span class="mini-label">Target chars</span>
              <input id="chunkTargetChars" type="number" value="800" style="width:120px;"/>
            </div>
            <div class="stack mini">
              <span class="mini-label">Max chars</span>
              <input id="chunkMaxChars" type="number" value="1200" style="width:120px;"/>
            </div>
            <div class="stack mini">
              <span class="mini-label">Overlap</span>
              <input id="chunkOverlap" type="number" value="0" style="width:100px;"/>
            </div>
          </div>
        </div>
        <div class="row" style="align-items:center; gap:10px;">
          <div id="chunkStatus" class="muted">Paste text or load by document ID to begin.</div>
          <div id="chunkSpinner" class="spinner" style="display:none;"><span class="spinner-text">Contacting OpenAI…</span></div>
        </div>
      </div>

      <div class="chunk-layout" style="margin-top:12px;">
        <div class="stack chunk-main">
          <label>Document with chunk overlays</label>
          <div class="chunk-viewport" id="chunkViewport" aria-label="Chunk review viewport"></div>
          <div class="row" style="margin-top:6px; justify-content:space-between;">
            <div class="muted" id="chunkStats"></div>
            <div class="row" style="gap:8px;">
              <button class="ghost" id="chunkSelectionBtn">Create chunk from selection</button>
              <button class="secondary" id="chunkScrollTopBtn">Scroll to start</button>
            </div>
          </div>
        </div>
        <div class="stack chunk-sidebar">
          <div id="docSummary"></div>
          <label>Chunk list &amp; handles</label>
          <div id="chunkList" class="chunk-list"></div>
        </div>
      </div>
    </section>
  </div>

  <div class="tab-panel" data-panel="connections" style="display:none;">
    <section class="card">
      <div class="card-header">
        <div>
          <h2 style="margin:0;">Connections</h2>
          <p class="card-subtitle">Upsert or delete relationships between things.</p>
        </div>
        <div class="row">
          <button class="ghost" onclick="loadConnections()">Refresh</button>
        </div>
      </div>
      <div class="grid two-col">
        <div class="stack">
          <label>Edge ID</label>
          <input id="edgeFormId" type="text" placeholder="edge.character.sahla.homeworld"/>
        </div>
        <div class="stack">
          <label>Relationship type</label>
          <input id="edgeRelType" type="text" placeholder="homeworld_of"/>
        </div>
      </div>
      <div class="grid three-col" style="margin-top:12px;">
        <div class="stack">
          <label>Source thing ID</label>
          <input id="edgeSrc" type="text" placeholder="character.sahla"/>
        </div>
        <div class="stack">
          <label>Destination thing ID</label>
          <input id="edgeDst" type="text" placeholder="place.kaar"/>
        </div>
        <div class="stack">
          <label>Tags</label>
          <input id="edgeTags" type="text" placeholder="comma separated"/>
        </div>
      </div>
      <div class="stack" style="margin-top:12px;">
        <label>Note</label>
        <textarea id="edgeNote" rows="3" placeholder="Short description of the connection"></textarea>
      </div>

      <div class="row" style="margin-top:12px;">
        <button onclick="saveConnection()">Save connection</button>
        <button class="danger" onclick="deleteConnection()">Delete connection</button>
        <div id="connectionsMsg" class="muted"></div>
      </div>

      <div class="divider"></div>
      <div id="connectionsList"></div>
    </section>
  </div>

  <div id="cardModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="card-header">
        <div>
          <h2 style="margin:0;">Add or edit lore card</h2>
          <p class="card-subtitle">Create chunks with clear IDs, assign kinds, and keep metadata tidy.</p>
        </div>
        <button class="secondary" onclick="closeCardModal()">Close</button>
      </div>

      <div class="grid two-col">
        <div class="stack">
          <label>Card ID</label>
          <input id="chunkId" type="text" placeholder="chunk.character.sahla.summary"/>
          <div class="input-note">Use readable, stable IDs. Saving again updates the same card.</div>
        </div>
        <div class="stack">
          <label>Card kind</label>
          <select id="chunkKind">
            <option value="thing_summary">thing_summary</option>
            <option value="thing_notes">thing_notes</option>
            <option value="connection_note">connection_note</option>
            <option value="chapter_text">chapter_text</option>
            <option value="scene_text">scene_text</option>
            <option value="rule_text">rule_text</option>
            <option value="misc">misc</option>
          </select>
        </div>
      </div>

      <div class="grid three-col">
        <div class="stack">
          <label>Thing ID</label>
          <input id="thingId" type="text" placeholder="character.sahla"/>
        </div>
        <div class="stack">
          <label>Thing type</label>
          <input id="thingType" type="text" placeholder="character"/>
        </div>
        <div class="stack">
          <label>Edge / connection ID</label>
          <input id="edgeId" type="text" placeholder="edge.character.sahla.homeworld"/>
        </div>
      </div>

      <div class="stack" style="margin-top:8px;">
        <label>Lore text</label>
        <textarea id="chunkText" rows="5" placeholder="Summary, excerpt, rule, or connection note."></textarea>
        <div class="input-note">Short, focused cards search better.</div>
      </div>

      <div class="grid three-col" style="margin-top:12px;">
        <div class="stack">
          <label>Tags</label>
          <input id="tags" type="text" placeholder="comma separated"/>
        </div>
        <div class="stack">
          <label>Entity IDs</label>
          <input id="entityIds" type="text" placeholder="comma separated"/>
        </div>
        <div class="stack">
          <label>Source file / section</label>
          <div class="row" style="gap:10px;">
            <input id="sourceFile" type="text" placeholder="source_file"/>
            <input id="sourceSection" type="text" placeholder="section"/>
          </div>
        </div>
      </div>

      <details class="mt" style="margin-top:12px;">
        <summary>Chapter-style filters (optional)</summary>
        <div class="grid three-col" style="margin-top:12px;">
          <input id="chapterNumber" type="number" placeholder="chapter_number"/>
          <input id="sceneId" type="text" placeholder="scene_id"/>
          <input id="pov" type="text" placeholder="pov"/>
          <input id="locationId" type="text" placeholder="location_id"/>
        </div>
      </details>

      <details class="mt" style="margin-top:12px;">
        <summary>Extra metadata (optional JSON object)</summary>
        <textarea id="extraJson" rows="4" placeholder='{"draft_state":"revise","scene_id":"scene.12"}'></textarea>
      </details>

      <div class="row" style="margin-top:12px;">
        <button onclick="upsertChunk('{{ collection }}')">Save lore card</button>
        <button class="secondary" onclick="closeCardModal()">Cancel</button>
        <div id="upsertMsg" class="muted"></div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    window.collectionName = {{ collection | tojson }};
  </script>
  <script type="module" src="/static/js/chunk-review.js"></script>
{% endblock %}
